name: main
on:
  workflow_dispatch:
  # push:
  schedule:
    - cron: 8 19 * * *  # 保留你设定的 UTC 19:08 触发（对应北京时间次日 03:08）
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v3

      - name: 创建node环境
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: ./api/package-lock.json

      - name: 缓存 api 目录的 node_modules
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ./api/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('./api/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: 安装依赖（缓存未命中时执行）
        run: npm install
        working-directory: ./api  # 确保在 api 目录安装依赖
        if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}

      - name: 签到（直接执行 main.js，带3次重试，日志和原版一致）
        run: |
          cd ./api
          MAX_ATTEMPTS=3
          RETRY_DELAY=300
          attempt=1
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            echo "==================== 第 $attempt 次尝试签到 ===================="
            # 核心修改：先执行 node main.js，让所有日志完整输出
            node main.js
            # 再捕获退出码判断成败
            result=$?
            if [ $result -eq 0 ]; then
              echo "==================== 第 $attempt 次签到成功 ===================="
              exit 0
            else
              echo "==================== 第 $attempt 次签到失败 ===================="
              if [ $attempt -lt $MAX_ATTEMPTS ]; then
                echo "等待 $RETRY_DELAY 秒（5分钟）后重试..."
                sleep $RETRY_DELAY
              else
                echo "==================== 3次重试全部失败 ===================="
                exit 1
              fi
            fi
            attempt=$((attempt + 1))
          done
        env:
          USERINFO: ${{ secrets.USERINFO }}
